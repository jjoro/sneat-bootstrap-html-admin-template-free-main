<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart.js 스타일 헬퍼</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* 추가적인 스타일링 */
        body {
            background-color: #f8f9fa;
        }

        .container {
            margin-top: 2rem;
        }

        /* 색상 팔레트 스타일 */
        .color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .color-box {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .color-box:hover {
            transform: scale(1.1);
        }

        #myChart {
            max-height: 350px;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1>Chart.js 스타일 헬퍼</h1>
            <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight"
                aria-controls="offcanvasRight">
                스타일 메뉴 열기
            </button>
        </div>

        <div class="card">
            <div class="card-body">
                <canvas id="myChart"></canvas>
            </div>
        </div>
    </div>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
        <div class="offcanvas-header">
            <h5 id="offcanvasRightLabel">차트 스타일 변경</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <h6>차트 색상</h6>
            <div class="color-palette mb-4" id="colorPalette">
            </div>

            <h6>차트 종류</h6>
            <div class="btn-group w-100 mb-4" role="group" id="chartTypeSelector">
                <button type="button" class="btn btn-outline-secondary btn-type" data-type="bar">막대</button>
                <button type="button" class="btn btn-outline-secondary btn-type" data-type="line">선</button>
                <button type="button" class="btn btn-outline-secondary btn-type" data-type="pie">파이</button>
                <button type="button" class="btn btn-outline-secondary btn-type" data-type="doughnut">도넛</button>
            </div>

            <h6>범례 위치</h6>
            <!-- [수정됨] data-position 대신 data-align을 사용하고, Chart.js에 맞는 값('start', 'center', 'end')으로 변경 -->
            <div class="btn-group w-100" role="group" id="legendPositionSelector">
                <button type="button" class="btn btn-outline-secondary btn-legend" data-align="start">왼쪽</button>
                <button type="button" class="btn btn-outline-secondary btn-legend" data-align="center">가운데</button>
                <button type="button" class="btn btn-outline-secondary btn-legend" data-align="end">오른쪽</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const ctx = document.getElementById('myChart').getContext('2d');
            let myChart;

            const colors = [
                'rgba(255, 99, 132, 0.5)', 'rgba(54, 162, 235, 0.5)', 'rgba(255, 206, 86, 0.5)',
                'rgba(75, 192, 192, 0.5)', 'rgba(153, 102, 255, 0.5)', 'rgba(255, 159, 64, 0.5)',
                'rgba(201, 203, 207, 0.5)', 'rgba(10, 150, 50, 0.5)'
            ];

            const initialData = {
                labels: ['1월', '2월', '3월', '4월', '5월', '6월'],
                datasets: [{
                    label: '월별 판매량',
                    data: [12, 19, 3, 5, 2, 3],
                    borderWidth: 1
                }]
            };

            const initialOptions = {
                responsive: true,
                scales: { // 막대/선 차트를 위한 기본 축 설정
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',      // 위치는 항상 'top'으로 고정
                        align: 'center',      // 기본 정렬은 'center'
                    },
                    title: {
                        display: true,
                        text: '샘플 차트'
                    }
                }
            };

            function createChart(type, data, options) {
                if (myChart) {
                    myChart.destroy();
                }
                myChart = new Chart(ctx, {
                    type: type,
                    data: data,
                    options: options
                });
            }

            // --- 컨트롤러 기능 구현 ---

            // 1. 색상 팔레트 생성 및 이벤트 처리
            const colorPalette = document.getElementById('colorPalette');
            colors.forEach(color => {
                const colorBox = document.createElement('div');
                colorBox.className = 'color-box';
                colorBox.style.backgroundColor = color;
                colorBox.dataset.color = color;
                colorPalette.appendChild(colorBox);

                colorBox.addEventListener('click', (e) => {
                    const selectedColor = e.target.dataset.color;
                    const currentType = myChart.config.type;

                    if (currentType === 'pie' || currentType === 'doughnut') {
                        const newColors = myChart.data.datasets[0].data.map(() => selectedColor);
                        myChart.data.datasets[0].backgroundColor = newColors;
                        myChart.data.datasets[0].borderColor = '#ffffff';
                    } else {
                        myChart.data.datasets[0].backgroundColor = selectedColor;
                        myChart.data.datasets[0].borderColor = selectedColor.replace('0.5', '1');
                    }
                    myChart.update();
                });
            });

            // 2. 차트 타입 변경 시 데이터와 옵션을 새로 구성
            document.getElementById('chartTypeSelector').addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-type')) {
                    const newType = e.target.dataset.type;

                    const newData = JSON.parse(JSON.stringify(initialData));
                    const newOptions = JSON.parse(JSON.stringify(initialOptions));

                    // 사용자가 변경한 범례 정렬(align) 값은 유지
                    if (myChart) {
                        newOptions.plugins.legend.align = myChart.options.plugins.legend.align;
                    }

                    // 새 차트 타입에 맞게 데이터와 옵션 조정
                    if (newType === 'pie' || newType === 'doughnut') {
                        newData.datasets[0].backgroundColor = colors;
                        newData.datasets[0].borderColor = '#ffffff';
                        // 파이/도넛 차트에서는 scales 옵션을 제거
                        delete newOptions.scales;
                    } else {
                        newData.datasets[0].backgroundColor = 'rgba(54, 162, 235, 0.5)';
                        newData.datasets[0].borderColor = 'rgba(54, 162, 235, 1)';
                    }
                    createChart(newType, newData, newOptions);
                }
            });

            // 3. 범례 위치 변경 이벤트 처리
            // [수정됨] data-align 속성을 읽어 legend.align 값을 변경하도록 수정
            document.getElementById('legendPositionSelector').addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-legend')) {
                    if (!myChart) return;

                    // HTML 버튼의 data-align 속성 값('start', 'center', 'end')을 가져옵니다.
                    const newAlign = e.target.dataset.align;

                    // 차트 옵션에서 범례의 정렬(align) 속성을 업데이트합니다.
                    myChart.options.plugins.legend.align = newAlign;

                    // 차트를 업데이트하여 변경사항을 적용합니다.
                    myChart.update();
                }
            });

            // 페이지 로드 시 첫 차트를 'bar' 타입으로 생성
            document.querySelector('.btn-type[data-type="bar"]').click();
        });
    </script>
</body>

</html>